<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Insurance CRM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      -webkit-font-smoothing: antialiased;
    }
    .tab-active { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    .modal { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 50; 
      animation: fadeIn 0.2s ease;
    }
    .modal.active { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }
    .modal-content {
      animation: slideUp 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
    }
    .badge { 
      font-size: 0.7rem; 
      padding: 0.3rem 0.65rem; 
      border-radius: 20px; 
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
      transform: translateY(-2px);
    }
    .btn-call {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      transition: all 0.3s ease;
    }
    .btn-call:hover {
      box-shadow: 0 8px 16px rgba(16, 185, 129, 0.4);
      transform: translateY(-2px);
    }
    .btn-whatsapp {
      background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
      transition: all 0.3s ease;
    }
    .btn-whatsapp:hover {
      box-shadow: 0 8px 16px rgba(37, 211, 102, 0.4);
      transform: translateY(-2px);
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .chip-filter {
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    .chip-filter:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .chip-active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white !important;
      border-color: #667eea;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">

  <!-- Header -->
  <header class="glass-effect shadow-sm sticky top-0 z-40 border-b border-gray-200">
    <div class="px-5 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl gradient-bg flex items-center justify-center text-white text-xl">
            üè•
          </div>
          <div>
            <h1 class="text-xl font-bold text-gray-800">Insurance CRM</h1>
            <p class="text-xs text-gray-500 font-light">Care Supreme - Policy Management</p>
          </div>
        </div>
        <button onclick="switchTab('settings')" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white hover:bg-gray-100 border border-gray-200 transition-all text-xl">
          ‚öôÔ∏è
        </button>
      </div>
    </div>
    
    <!-- Tabs -->
    <div class="flex gap-2 px-4 pb-4">
      <button onclick="switchTab('all')" id="tab-all" class="tab-active flex-1 px-4 py-2.5 text-xs font-semibold rounded-xl">
        All <span id="count-all" class="ml-1">0</span>
      </button>
      <button onclick="switchTab('pending')" id="tab-pending" class="flex-1 px-4 py-2.5 text-xs font-semibold text-gray-600 bg-white rounded-xl">
        Pending <span id="count-pending" class="ml-1">0</span>
      </button>
      <button onclick="switchTab('contacted')" id="tab-contacted" class="flex-1 px-4 py-2.5 text-xs font-semibold text-gray-600 bg-white rounded-xl">
        Done <span id="count-contacted" class="ml-1">0</span>
      </button>
      <button onclick="switchTab('callback')" id="tab-callback" class="flex-1 px-4 py-2.5 text-xs font-semibold text-gray-600 bg-white rounded-xl">
        Callback <span id="count-callback" class="ml-1">0</span>
      </button>
    </div>
    
    <!-- Done Filter Chips (shown only when Done tab is active) -->
    <div id="doneFilterChips" class="px-4 pb-4 hidden">
      <div class="flex gap-2 flex-wrap">
        <button onclick="setDoneFilter('all')" id="chip-all" class="chip-filter chip-active px-3 py-1.5 text-xs font-semibold rounded-full">
          All
        </button>
        <button onclick="setDoneFilter('interested')" id="chip-interested" class="chip-filter px-3 py-1.5 text-xs font-semibold rounded-full bg-green-50 text-green-600">
          ‚úÖ Interested
        </button>
        <button onclick="setDoneFilter('not_interested')" id="chip-not_interested" class="chip-filter px-3 py-1.5 text-xs font-semibold rounded-full bg-red-50 text-red-600">
          ‚ùå Not Interested
        </button>
        <button onclick="setDoneFilter('wrong_number')" id="chip-wrong_number" class="chip-filter px-3 py-1.5 text-xs font-semibold rounded-full bg-gray-50 text-gray-600">
          üö´ Wrong Number
        </button>
        <button onclick="setDoneFilter('not_reachable')" id="chip-not_reachable" class="chip-filter px-3 py-1.5 text-xs font-semibold rounded-full bg-orange-50 text-orange-600">
          üìµ Not Reachable
        </button>
        <button onclick="setDoneFilter('already_renewed')" id="chip-already_renewed" class="chip-filter px-3 py-1.5 text-xs font-semibold rounded-full bg-blue-50 text-blue-600">
          ‚úîÔ∏è Renewed
        </button>
        <button onclick="setDoneFilter('will_think')" id="chip-will_think" class="chip-filter px-3 py-1.5 text-xs font-semibold rounded-full bg-purple-50 text-purple-600">
          ü§î Thinking
        </button>
      </div>
    </div>
  </header>

  <!-- Search Bar -->
  <div id="searchBar" class="px-5 py-4">
    <div class="relative">
      <input type="text" id="searchInput" placeholder="Search by name, policy, or phone..." 
        class="w-full pl-11 pr-4 py-3 bg-white border border-gray-200 rounded-2xl text-sm">
      <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">üîç</span>
    </div>
  </div>

  <!-- Settings Tab Content -->
  <div id="settingsContent" class="px-5 py-6 hidden">
    <div class="max-w-2xl mx-auto space-y-5">
      <!-- Import Section -->
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-3xl p-6 border-2 border-blue-100 shadow-sm">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-2xl flex-shrink-0">
            üì•
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Import Customer Data</h3>
            <p class="text-sm text-gray-600 mb-4 leading-relaxed">Upload your CSV file with customer leads. Make sure to use the correct format by downloading our template first.</p>
            
            <div class="flex gap-3">
              <button onclick="downloadSampleTemplate()" class="flex-1 bg-white border-2 border-blue-300 text-blue-700 font-semibold py-3 px-5 rounded-xl text-sm hover:bg-blue-50 hover:border-blue-400 transition-all shadow-sm">
                üìÑ Download Template
              </button>
              
              <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
              <button onclick="document.getElementById('csvFileInput').click()" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold py-3 px-5 rounded-xl text-sm hover:shadow-lg transition-all">
                üì§ Upload CSV
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Export Section -->
      <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-3xl p-6 border-2 border-green-100 shadow-sm">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-2xl flex-shrink-0">
            üì§
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Export Complete Data</h3>
            <p class="text-sm text-gray-600 mb-4 leading-relaxed">Download all customer leads with complete disposition history, notes, callbacks, and interaction timeline.</p>
            
            <button onclick="exportData()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold py-3 px-5 rounded-xl text-sm hover:shadow-lg transition-all">
              üíæ Export to CSV
            </button>
          </div>
        </div>
      </div>

      <!-- Restore Backup Section -->
      <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-3xl p-6 border-2 border-orange-100 shadow-sm">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-orange-500 to-amber-600 flex items-center justify-center text-2xl flex-shrink-0">
            ‚ö°
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Restore from Backup</h3>
            <p class="text-sm text-gray-600 mb-4 leading-relaxed">Upload previously exported CSV file to restore all data including complete disposition history and notes.</p>
            
            <input type="file" id="backupFileInput" accept=".csv" class="hidden" onchange="handleBackupRestore(event)">
            <button onclick="document.getElementById('backupFileInput').click()" class="w-full bg-gradient-to-r from-orange-500 to-amber-600 text-white font-semibold py-3 px-5 rounded-xl text-sm hover:shadow-lg transition-all">
              üì• Restore Backup
            </button>
          </div>
        </div>
      </div>

      <!-- Stats Section -->
      <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-3xl p-6 border-2 border-purple-100 shadow-sm">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-2xl flex-shrink-0">
            üìä
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-3">System Statistics</h3>
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-white rounded-xl p-4">
                <div class="text-2xl font-bold text-purple-600" id="stat-total">0</div>
                <div class="text-xs text-gray-500 mt-1">Total Leads</div>
              </div>
              <div class="bg-white rounded-xl p-4">
                <div class="text-2xl font-bold text-green-600" id="stat-contacted">0</div>
                <div class="text-xs text-gray-500 mt-1">Contacted</div>
              </div>
              <div class="bg-white rounded-xl p-4">
                <div class="text-2xl font-bold text-orange-600" id="stat-pending">0</div>
                <div class="text-xs text-gray-500 mt-1">Pending</div>
              </div>
              <div class="bg-white rounded-xl p-4">
                <div class="text-2xl font-bold text-yellow-600" id="stat-callback">0</div>
                <div class="text-xs text-gray-500 mt-1">Callbacks</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cards Container -->
  <div id="cardsContainer" class="px-5 pb-6 space-y-4"></div>

  <!-- Disposition Modal -->
  <div id="dispositionModal" class="modal">
    <div class="modal-content bg-white rounded-3xl shadow-2xl mx-4 w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white rounded-t-3xl px-6 py-5 flex justify-between items-center border-b border-gray-100">
        <h3 class="text-lg font-bold text-gray-800">Update Status</h3>
        <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 hover:text-gray-600 text-2xl transition-all">√ó</button>
      </div>
      
      <div class="p-6 space-y-5">
        <div id="modalCustomerInfo" class="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-2xl text-sm"></div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Disposition</label>
          <select id="dispositionSelect" class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl text-sm transition-all">
            <option value="">Select status...</option>
            <option value="interested">‚úÖ Interested</option>
            <option value="not_interested">‚ùå Not Interested</option>
            <option value="callback">üìû Callback Required</option>
            <option value="wrong_number">üö´ Wrong Number</option>
            <option value="not_reachable">üìµ Not Reachable</option>
            <option value="already_renewed">‚úîÔ∏è Already Renewed</option>
            <option value="will_think">ü§î Will Think</option>
          </select>
        </div>

        <div id="callbackSection" style="display:none;">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Callback Date & Time</label>
          <input type="datetime-local" id="callbackDateTime" class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl text-sm transition-all">
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
          <textarea id="dispositionNotes" rows="3" placeholder="Add notes about the conversation..." 
            class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl text-sm transition-all resize-none"></textarea>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">History</label>
          <div id="dispositionHistory" class="max-h-40 overflow-y-auto bg-gray-50 border border-gray-100 rounded-xl p-3 text-xs text-gray-700"></div>
        </div>

        <button onclick="saveDisposition()" class="w-full btn-primary text-white font-semibold py-3.5 rounded-xl">
          Save & Close
        </button>
      </div>
    </div>
  </div>

  <script>
    const data = [
      {sno:1, policy:"90931696", date:"11-Oct-2025", name:"Boya Tribhuvan Teja", phone:"9885562055", plan:"Care Supreme - SI: ‚Çπ17,50,000", dob:"32 yrs", amount:7562, sumInsured:"‚Çπ17,50,000", addonCost:645},
      {sno:2, policy:"91075578", date:"12-Oct-2025", name:"Gurparshad Singh", phone:"9501242244", plan:"Care Supreme - SI: ‚Çπ15,00,000 (4 members)", dob:"47, 44, 18, 14 yrs", amount:46627, sumInsured:"‚Çπ15,00,000", addonCost:2151},
      {sno:3, policy:"90931524", date:"13-Oct-2025", name:"Boya Varalakshmi Dev", phone:"9885562055", plan:"Care Supreme - SI: ‚Çπ17,50,000", dob:"65 yrs", amount:105604, sumInsured:"‚Çπ17,50,000", addonCost:2796},
      {sno:4, policy:"90936353", date:"14-Oct-2025", name:"Manu Bai Vishnoi", phone:"9167631985", plan:"Care Supreme - SI: ‚Çπ10,50,000", dob:"59 yrs", amount:19922, sumInsured:"‚Çπ10,50,000", addonCost:1704},
      {sno:5, policy:"91374698", date:"17-Oct-2025", name:"Apurva Gupta", phone:"9535684007", plan:"Care Supreme - SI: ‚Çπ1,25,00,000 (3 members)", dob:"36, 35, 2 yrs", amount:47884, sumInsured:"‚Çπ1,25,00,000", addonCost:0},
      {sno:6, policy:"91178196", date:"17-Oct-2025", name:"Omprakash Sahu", phone:"9893830775", plan:"Care Supreme - SI: ‚Çπ25,00,000 (4 members)", dob:"40, 37, 10, 2 yrs", amount:18158, sumInsured:"‚Çπ25,00,000", addonCost:1523},
      {sno:7, policy:"91270653", date:"20-Oct-2025", name:"Nandala Suresh", phone:"6303951543", plan:"Care Supreme - SI: ‚Çπ35,00,000 (3 members)", dob:"46, 40, 25 yrs", amount:42827, sumInsured:"‚Çπ35,00,000", addonCost:0},
      {sno:8, policy:"91290285", date:"21-Oct-2025", name:"Mohammed Shoaib Ul Huq", phone:"9900533007", plan:"Care Supreme - SI: ‚Çπ15,00,000 (3 members)", dob:"62, 56, 19 yrs", amount:48373, sumInsured:"‚Çπ15,00,000", addonCost:4183},
      {sno:9, policy:"91347202", date:"22-Oct-2025", name:"Dipan Banerjee", phone:"8584022210", plan:"Care Supreme - SI: ‚Çπ15,00,000 (2 members)", dob:"59, 58 yrs", amount:32028, sumInsured:"‚Çπ15,00,000", addonCost:2737},
      {sno:10, policy:"91540681", date:"24-Oct-2025", name:"Shashanka Sekhar Nath", phone:"7381252534", plan:"Care Supreme - SI: ‚Çπ10,50,000 (2 members)", dob:"64, 60 yrs", amount:41356, sumInsured:"‚Çπ10,50,000", addonCost:3585},
      {sno:11, policy:"90941094", date:"24-Oct-2025", name:"Mangiiash Anant Ingale", phone:"9860359501", plan:"Care Supreme - SI: ‚Çπ15,00,000 (3 members)", dob:"52, 43, 20 yrs", amount:33753, sumInsured:"‚Çπ15,00,000", addonCost:0},
      {sno:12, policy:"91681428", date:"26-Oct-2025", name:"Mrs Santosh", phone:"9760553925", plan:"Care Supreme - SI: ‚Çπ15,00,000", dob:"63 yrs", amount:29694, sumInsured:"‚Çπ15,00,000", addonCost:2592},
      {sno:13, policy:"91425871", date:"26-Oct-2025", name:"Nalla Purendar", phone:"9676315560", plan:"Care Supreme - SI: ‚Çπ25,00,000 (4 members)", dob:"42, 36, 10, 6 yrs", amount:25226, sumInsured:"‚Çπ25,00,000", addonCost:0},
      {sno:14, policy:"90934716", date:"27-Oct-2025", name:"Shyam Kishore", phone:"7090555530", plan:"Care Supreme - SI: ‚Çπ25,00,000 (4 members)", dob:"39, 30, 7, 2 yrs", amount:21358, sumInsured:"‚Çπ25,00,000", addonCost:1815},
      {sno:15, policy:"90999914", date:"29-Oct-2025", name:"Redy V S R Krishha Kumari", phone:"9030699991", plan:"Care Supreme - SI: ‚Çπ62,50,000 (2 members)", dob:"42, 11 yrs", amount:18941, sumInsured:"‚Çπ62,50,000", addonCost:1248},
      {sno:16, policy:"91763194", date:"29-Oct-2025", name:"Lakshmi Narasimha Rao Wunnava", phone:"9742544850", plan:"Care Supreme - SI: ‚Çπ25,00,000", dob:"89 yrs", amount:94414, sumInsured:"‚Çπ25,00,000", addonCost:8541},
      {sno:17, policy:"91574188", date:"30-Oct-2025", name:"Dnyaneshwar Hiraman Gaikwad", phone:"9421525223", plan:"Care Supreme - SI: ‚Çπ25,00,000 (2 members)", dob:"65, 60 yrs", amount:38495, sumInsured:"‚Çπ25,00,000", addonCost:0},
      {sno:18, policy:"91653682", date:"31-Oct-2025", name:"Shanker Venkata Wunnava", phone:"9742544850", plan:"Care Supreme - SI: ‚Çπ37,50,000 (3 members)", dob:"57, 50, 12 yrs", amount:51552, sumInsured:"‚Çπ37,50,000", addonCost:3562}
    ];

    let dispositions = {};
    const STORAGE_KEY = 'rnl_dispositions';
    const DATA_STORAGE_KEY = 'rnl_customer_data';
    let currentTab = 'all';
    let currentDoneFilter = 'all';
    let currentPolicy = null;

    function getWhatsAppLink(item) {
      const basePremium = item.amount - item.addonCost;
      const discountAmount = Math.round(basePremium * 0.05);
      const finalAmount = basePremium - discountAmount;
      
      const message = `Hello ${item.name},

This is regarding your Care Supreme policy renewal:

üìã *Policy Details:*
Policy No: ${item.policy}
Sum Insured: ${item.sumInsured}
Expiry Date: ${item.date}

üí∞ *Premium Details:*
Base Premium: ‚Çπ${basePremium.toLocaleString("en-IN")}

üéâ *Sunday Exclusive Offer!*
Pay today and get 5% OFF
Discount: ‚Çπ${discountAmount.toLocaleString("en-IN")}
*Final Amount: ‚Çπ${finalAmount.toLocaleString("en-IN")}*

This special offer is valid only for today. Would you like to proceed with the renewal?`;

      return `https://wa.me/91${item.phone}?text=${encodeURIComponent(message)}`;
    }

    function getDisposition(policy) {
      const d = dispositions[policy];
      if (!d) return { status: 'pending', notes: '', callback: null, history: [] };
      if (!Array.isArray(d.history)) d.history = [];
      return d;
    }

    function setDisposition(policy, data) {
      dispositions[policy] = data;
      saveDispositions();
      renderCards();
      updateCounts();
    }

    function loadDispositions() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          dispositions = JSON.parse(raw) || {};
        }
      } catch (e) {
        console.warn('Could not load dispositions from localStorage', e);
        dispositions = {};
      }
      
      try {
        const customData = localStorage.getItem(DATA_STORAGE_KEY);
        if (customData) {
          const parsed = JSON.parse(customData);
          if (Array.isArray(parsed) && parsed.length > 0) {
            data.length = 0;
            data.push(...parsed);
          }
        }
      } catch (e) {
        console.warn('Could not load custom data', e);
      }
    }

    function saveDispositions() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(dispositions));
      } catch (e) {
        console.warn('Could not save dispositions to localStorage', e);
      }
    }

    function getStatusBadge(status) {
      const badges = {
        pending: '<span class="badge bg-gray-100 text-gray-600">‚è≥ Pending</span>',
        interested: '<span class="badge bg-green-50 text-green-600">‚úÖ Interested</span>',
        not_interested: '<span class="badge bg-red-50 text-red-600">‚ùå Not Interested</span>',
        callback: '<span class="badge bg-yellow-50 text-yellow-600">üìû Callback</span>',
        wrong_number: '<span class="badge bg-gray-50 text-gray-500">üö´ Wrong Number</span>',
        not_reachable: '<span class="badge bg-orange-50 text-orange-600">üìµ Not Reachable</span>',
        already_renewed: '<span class="badge bg-blue-50 text-blue-600">‚úîÔ∏è Renewed</span>',
        will_think: '<span class="badge bg-purple-50 text-purple-600">ü§î Thinking</span>'
      };
      return badges[status] || badges.pending;
    }

    function renderCards() {
      const container = document.getElementById("cardsContainer");
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();
      
      container.innerHTML = '';
      
      let filtered = data.filter(item => {
        const disp = getDisposition(item.policy);
        const matchesSearch = !searchTerm || 
          item.name.toLowerCase().includes(searchTerm) ||
          item.policy.includes(searchTerm) ||
          item.phone.includes(searchTerm);
        
        if (!matchesSearch) return false;
        
        if (currentTab === 'all') return true;
        if (currentTab === 'pending') return disp.status === 'pending';
        if (currentTab === 'contacted') {
          const isDone = disp.status !== 'pending' && disp.status !== 'callback';
          if (!isDone) return false;
          
          if (currentDoneFilter === 'all') return true;
          return disp.status === currentDoneFilter;
        }
        if (currentTab === 'callback') return disp.status === 'callback';
        
        return true;
      });

      if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center py-16 text-gray-400 text-sm">No records found</div>';
        return;
      }

      if (currentTab === 'contacted') {
        filtered.sort((a, b) => {
          const dispA = getDisposition(a.policy);
          const dispB = getDisposition(b.policy);
          const timeA = dispA.lastUpdated ? new Date(dispA.lastUpdated).getTime() : 0;
          const timeB = dispB.lastUpdated ? new Date(dispB.lastUpdated).getTime() : 0;
          return timeB - timeA;
        });
      }

      filtered.forEach(item => {
        const disp = getDisposition(item.policy);
        const hasCallback = disp.callback && new Date(disp.callback) > new Date();
        
        const card = document.createElement("div");
        card.className = "card bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden";

        card.innerHTML = `
          <div class="p-5">
            <div class="flex justify-between items-start mb-4">
              <div class="flex-1">
                <h3 class="font-bold text-gray-800 text-base mb-1 leading-tight">${item.name}</h3>
                <p class="text-xs text-gray-400 font-light">Expiry: ${item.date}</p>
              </div>
              ${getStatusBadge(disp.status)}
            </div>
            
            ${hasCallback ? `
              <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-100 rounded-xl p-3 mb-4 text-xs">
                <div class="flex items-center gap-2">
                  <span class="text-lg">‚è∞</span>
                  <div>
                    <div class="font-semibold text-yellow-800">Callback Scheduled</div>
                    <div class="text-yellow-700 mt-0.5">${new Date(disp.callback).toLocaleString('en-IN', {day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'})}</div>
                  </div>
                </div>
              </div>
            ` : ''}
            
            <div class="space-y-2 mb-4">
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-400 font-light">Policy</span>
                <span class="text-gray-700 font-medium">${item.policy}</span>
              </div>
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-400 font-light">Age</span>
                <span class="text-gray-700">${item.dob}</span>
              </div>
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-400 font-light">Premium</span>
                <span class="text-gray-800 font-bold">‚Çπ${item.amount.toLocaleString("en-IN")}</span>
              </div>
            </div>
            
            <div class="bg-gray-50 rounded-xl p-3 mb-4 text-xs text-gray-600">
              <div class="font-medium text-gray-700 mb-1">Plan Details</div>
              <div class="leading-relaxed">${item.plan}</div>
              ${item.addonCost > 0 ? `<div class="mt-2 text-purple-600 font-medium">Add-on Cost: ‚Çπ${item.addonCost.toLocaleString("en-IN")}</div>` : ''}
            </div>
            
            ${disp.notes ? `
              <div class="bg-blue-50 rounded-xl p-3 mb-4 text-xs">
                <div class="flex gap-2">
                  <span class="text-base">üìù</span>
                  <div class="text-gray-700 leading-relaxed">${disp.notes}</div>
                </div>
              </div>
            ` : ''}
            
            <div class="grid grid-cols-3 gap-2">
              <a href="tel:${item.phone}" 
                class="btn-call text-white font-semibold py-3 px-2 rounded-xl text-xs text-center flex items-center justify-center">
                üìû Call
              </a>
              <a href="${getWhatsAppLink(item)}" 
                target="_blank"
                class="btn-whatsapp text-white font-semibold py-3 px-2 rounded-xl text-xs text-center flex items-center justify-center">
                üí¨ WhatsApp
              </a>
              <button onclick="openModal('${item.policy}')" 
                class="btn-primary text-white font-semibold py-3 px-2 rounded-xl text-xs">
                Update
              </button>
            </div>
            
            <div class="mt-3 text-center">
              <span class="text-xs text-gray-400 font-light">${item.phone}</span>
            </div>
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    function switchTab(tab) {
      currentTab = tab;
      
      document.querySelectorAll('[id^="tab-"]').forEach(t => {
        t.classList.remove('tab-active');
        t.classList.add('text-gray-600', 'bg-white');
      });
      
      document.getElementById(`tab-${tab}`).classList.add('tab-active');
      document.getElementById(`tab-${tab}`).classList.remove('text-gray-600', 'bg-white');
      
      const searchBar = document.getElementById('searchBar');
      const cardsContainer = document.getElementById('cardsContainer');
      const settingsContent = document.getElementById('settingsContent');
      const doneChips = document.getElementById('doneFilterChips');
      
      if (tab === 'settings') {
        searchBar.classList.add('hidden');
        cardsContainer.classList.add('hidden');
        doneChips.classList.add('hidden');
        settingsContent.classList.remove('hidden');
        updateSettingsStats();
      } else {
        searchBar.classList.remove('hidden');
        cardsContainer.classList.remove('hidden');
        settingsContent.classList.add('hidden');
        
        if (tab === 'contacted') {
          doneChips.classList.remove('hidden');
        } else {
          doneChips.classList.add('hidden');
          currentDoneFilter = 'all';
        }
        
        renderCards();
      }
    }

    function updateSettingsStats() {
      const all = data.length;
      const pending = data.filter(item => getDisposition(item.policy).status === 'pending').length;
      const contacted = data.filter(item => {
        const status = getDisposition(item.policy).status;
        return status !== 'pending' && status !== 'callback';
      }).length;
      const callback = data.filter(item => getDisposition(item.policy).status === 'callback').length;
      
      document.getElementById('stat-total').textContent = all;
      document.getElementById('stat-contacted').textContent = contacted;
      document.getElementById('stat-pending').textContent = pending;
      document.getElementById('stat-callback').textContent = callback;
    }

    function setDoneFilter(filter) {
      currentDoneFilter = filter;
      
      document.querySelectorAll('.chip-filter').forEach(chip => {
        chip.classList.remove('chip-active');
      });
      
      document.getElementById(`chip-${filter}`).classList.add('chip-active');
      
      renderCards();
    }

    function updateCounts() {
      const all = data.length;
      const pending = data.filter(item => getDisposition(item.policy).status === 'pending').length;
      const contacted = data.filter(item => {
        const status = getDisposition(item.policy).status;
        return status !== 'pending' && status !== 'callback';
      }).length;
      const callback = data.filter(item => getDisposition(item.policy).status === 'callback').length;
      
      document.getElementById('count-all').textContent = all;
      document.getElementById('count-pending').textContent = pending;
      document.getElementById('count-contacted').textContent = contacted;
      document.getElementById('count-callback').textContent = callback;
    }

    function openModal(policy) {
      currentPolicy = policy;
      const item = data.find(d => d.policy === policy);
      const disp = getDisposition(policy);
      
      document.getElementById('modalCustomerInfo').innerHTML = `
        <div class="font-bold text-gray-800 text-base">${item.name}</div>
        <div class="text-xs text-gray-600 mt-2 font-light">Policy: ${item.policy}</div>
      `;
      
      document.getElementById('dispositionSelect').value = disp.status === 'pending' ? '' : disp.status;
      document.getElementById('dispositionNotes').value = disp.notes || '';
      document.getElementById('callbackDateTime').value = disp.callback || '';

      renderHistory(disp.history || []);
      
      document.getElementById('dispositionModal').classList.add('active');
      
      if (disp.status === 'callback') {
        document.getElementById('callbackSection').style.display = 'block';
      }
    }

    function closeModal() {
      document.getElementById('dispositionModal').classList.remove('active');
      currentPolicy = null;
    }

    function saveDisposition() {
      if (!currentPolicy) return;
      
      const status = document.getElementById('dispositionSelect').value;
      const notes = document.getElementById('dispositionNotes').value;
      const callback = document.getElementById('callbackDateTime').value;
      
      if (!status) {
        alert('Please select a disposition');
        return;
      }
      
      const disp = getDisposition(currentPolicy);
      disp.status = status;
      disp.notes = notes;
      disp.callback = status === 'callback' ? callback : null;
      disp.lastUpdated = new Date().toISOString();

      if (!disp.history) disp.history = [];
      const entry = {
        status,
        notes,
        callback: disp.callback || null,
        timestamp: new Date().toISOString()
      };
      disp.history.push(entry);

      setDisposition(currentPolicy, disp);
      renderHistory(disp.history);
      closeModal();
    }

    function renderHistory(history) {
      const el = document.getElementById('dispositionHistory');
      if (!el) return;
      if (!history || history.length === 0) {
        el.innerHTML = '<div class="text-gray-400">No history yet</div>';
        return;
      }

      const list = history.slice().reverse().map(h => {
        const dt = new Date(h.timestamp);
        const dateStr = dt.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        const timeStr = dt.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        const statusLabel = h.status ? h.status.replace(/_/g, ' ') : 'pending';
        const notes = h.notes ? `<div class="text-gray-700 mt-1">${escapeHtml(h.notes)}</div>` : '';
        const cb = h.callback ? `<div class="text-xs text-yellow-700 mt-1">Callback: ${new Date(h.callback).toLocaleString('en-IN', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</div>` : '';
        return `
          <div class="border-b border-gray-100 py-2">
            <div class="flex items-center justify-between">
              <div class="font-medium text-gray-700 text-sm">${escapeHtml(statusLabel)}</div>
              <div class="text-xs text-gray-400">${dateStr} ${timeStr}</div>
            </div>
            ${notes}
            ${cb}
          </div>
        `;
      }).join('');

      el.innerHTML = list;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    document.getElementById('dispositionSelect').addEventListener('change', (e) => {
      const section = document.getElementById('callbackSection');
      section.style.display = e.target.value === 'callback' ? 'block' : 'none';
    });

    document.getElementById('searchInput').addEventListener('input', renderCards);

    function downloadSampleTemplate() {
      const headers = ['policy_no', 'proposer', 'phone', 'plan_name', 'renewal_date', 'total_sum_insured', 'total_premium', 'proposed_addon_cost', 'ages'];
      const sampleData = [
        ['90931696', 'Boya Tribhuvan Teja', '9885562055', 'Care Supreme', '11-Oct-2025', '‚Çπ17,50,000', '7562', '645', '32'],
        ['91075578', 'Gurparshad Singh', '9501242244', 'Care Supreme', '12-Oct-2025', '‚Çπ15,00,000', '46627', '2151', '47, 44, 18, 14'],
        ['90931524', 'Boya Varalakshmi Dev', '9885562055', 'Care Supreme', '13-Oct-2025', '‚Çπ17,50,000', '105604', '2796', '65']
      ];
      
      const rows = [headers, ...sampleData];
      const csvContent = rows.map(row => row.join(',')).join('\n');
      
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'Insurance_CRM_Import_Template.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      alert('‚úÖ Template downloaded!\n\nUse these exact column headers:\n‚Ä¢ policy_no\n‚Ä¢ proposer\n‚Ä¢ phone\n‚Ä¢ plan_name\n‚Ä¢ renewal_date\n‚Ä¢ total_sum_insured\n‚Ä¢ total_premium\n‚Ä¢ proposed_addon_cost\n‚Ä¢ ages');
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const rows = text.split('\n').map(row => {
            const matches = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            return matches ? matches.map(cell => cell.replace(/^"|"$/g, '').trim()) : [];
          }).filter(row => row.length > 0);
          
          if (rows.length < 2) {
            alert('‚ùå CSV file must have headers and at least one data row');
            return;
          }
          
          const headers = rows[0].map(h => h.toLowerCase().trim());
          
          const requiredCols = ['policy_no', 'proposer', 'phone', 'plan_name', 'renewal_date', 'total_sum_insured', 'total_premium', 'proposed_addon_cost'];
          const missingCols = requiredCols.filter(col => !headers.includes(col));
          
          if (missingCols.length > 0) {
            alert(`‚ùå Missing required columns: ${missingCols.join(', ')}\n\nPlease download the sample template and use the correct format.`);
            return;
          }
          
          const newData = [];
          let errorCount = 0;
          
          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (row.length < headers.length || !row[0]) continue;
            
            try {
              const getCell = (colName) => {
                const idx = headers.indexOf(colName.toLowerCase());
                return idx >= 0 ? row[idx] : '';
              };
              
              const premium = parseInt(getCell('total_premium').replace(/[^0-9]/g, '')) || 0;
              const addonCost = parseInt(getCell('proposed_addon_cost').replace(/[^0-9]/g, '')) || 0;
              const sumInsured = getCell('total_sum_insured');
              const planName = getCell('plan_name');
              
              const item = {
                sno: newData.length + 1,
                policy: getCell('policy_no'),
                name: getCell('proposer'),
                phone: getCell('phone').replace(/[^0-9]/g, ''),
                date: getCell('renewal_date'),
                plan: `${planName} - SI: ${sumInsured}`,
                dob: getCell('ages') || 'N/A',
                amount: premium,
                sumInsured: sumInsured,
                addonCost: addonCost
              };
              
              if (!item.policy || !item.name || !item.phone) {
                errorCount++;
                continue;
              }
              
              newData.push(item);
            } catch (err) {
              errorCount++;
              console.warn(`Error processing row ${i}:`, err);
            }
          }
          
          if (newData.length === 0) {
            alert('‚ùå No valid data found in CSV file');
            return;
          }
          
          const confirmMsg = `Import ${newData.length} new leads?\n\n‚ö†Ô∏è This will replace your current ${data.length} leads.\n${errorCount > 0 ? `\n${errorCount} rows had errors and were skipped.` : ''}`;
          
          if (!confirm(confirmMsg)) {
            return;
          }
          
          data.length = 0;
          data.push(...newData);
          
          localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(data));
          
          renderCards();
          updateCounts();
          
          alert(`‚úÖ Successfully imported ${newData.length} leads!${errorCount > 0 ? `\n‚ö†Ô∏è ${errorCount} rows were skipped due to errors.` : ''}`);
        } catch (error) {
          alert('‚ùå Error reading CSV file: ' + error.message);
          console.error('Import error:', error);
        }
      };
      
      reader.readAsText(file);
      event.target.value = '';
    }

    function exportData() {
      if (data.length === 0) {
        alert('‚ùå No data to export!');
        return;
      }

      const headers = [
        'Policy No',
        'Customer Name', 
        'Phone Number',
        'Plan Name',
        'Renewal Date',
        'Sum Insured',
        'Total Premium',
        'Addon Cost',
        'Age/DOB',
        'Current Status',
        'Latest Notes',
        'Callback Date/Time',
        'Last Updated',
        'Total Calls',
        'Complete Disposition Log'
      ];
      
      const exportRows = data.map(item => {
        const disp = getDisposition(item.policy);
        const callCount = (disp.history || []).length;
        
        const dispositionLog = (disp.history || []).map((h, idx) => {
          const timestamp = new Date(h.timestamp);
          const dateStr = timestamp.toLocaleDateString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
          });
          const timeStr = timestamp.toLocaleTimeString('en-IN', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
          
          const status = (h.status || 'pending').replace(/_/g, ' ').toUpperCase();
          const notes = h.notes ? h.notes.trim() : 'No notes';
          
          let logEntry = `Call ${idx + 1}: [${dateStr} at ${timeStr}] Status: ${status} | Notes: ${notes}`;
          
          if (h.callback) {
            const cbTime = new Date(h.callback);
            const cbDateStr = cbTime.toLocaleDateString('en-IN', {
              day: '2-digit',
              month: 'short',
              year: 'numeric'
            });
            const cbTimeStr = cbTime.toLocaleTimeString('en-IN', {
              hour: '2-digit',
              minute: '2-digit',
              hour12: true
            });
            logEntry += ` | Callback Scheduled: ${cbDateStr} at ${cbTimeStr}`;
          }
          
          return logEntry;
        }).join(' || ');
        
        const currentStatus = (disp.status || 'pending').replace(/_/g, ' ').toUpperCase();
        
        let callbackInfo = 'Not Scheduled';
        if (disp.callback) {
          const cbTime = new Date(disp.callback);
          callbackInfo = cbTime.toLocaleDateString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
          }) + ' at ' + cbTime.toLocaleTimeString('en-IN', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
        }
        
        let lastUpdated = 'Never';
        if (disp.lastUpdated) {
          const luTime = new Date(disp.lastUpdated);
          lastUpdated = luTime.toLocaleDateString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
          }) + ' at ' + luTime.toLocaleTimeString('en-IN', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
        }
        
        return [
          item.policy,
          item.name,
          item.phone,
          item.plan.split(' - SI:')[0] || item.plan,
          item.date,
          item.sumInsured,
          item.amount,
          item.addonCost || 0,
          item.dob,
          currentStatus,
          disp.notes || 'No notes added',
          callbackInfo,
          lastUpdated,
          callCount,
          dispositionLog || 'No interaction history available'
        ];
      });
      
      const csvRows = [headers, ...exportRows].map(row => {
        return row.map(cell => {
          const str = String(cell).replace(/"/g, '""');
          return `"${str}"`;
        }).join(',');
      }).join('\n');
      
      const blob = new Blob(['\uFEFF' + csvRows], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      
      const timestamp = new Date();
      const dateStr = timestamp.toISOString().split('T')[0];
      const fileName = `Insurance_CRM_Export_${dateStr}.csv`;
      
      link.setAttribute('href', url);
      link.setAttribute('download', fileName);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      const totalCalls = data.reduce((sum, item) => {
        const disp = getDisposition(item.policy);
        return sum + (disp.history || []).length;
      }, 0);
      
      alert(`‚úÖ Export Successful!\n\nüìä Summary:\n‚Ä¢ Total Leads: ${data.length}\n‚Ä¢ Total Interactions: ${totalCalls}\n‚Ä¢ File: ${fileName}\n\n‚ú® Export includes complete disposition logs with date, time, status, notes, and callbacks for each customer interaction.`);
    }

    function handleBackupRestore(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (!confirm('‚ö†Ô∏è Restore from backup?\n\nThis will replace ALL current data with the backup data.\n\nAre you sure you want to continue?')) {
        event.target.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const rows = text.split('\n').map(row => {
            const matches = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            return matches ? matches.map(cell => cell.replace(/^"|"$/g, '').trim()) : [];
          }).filter(row => row.length > 0);
          
          if (rows.length < 2) {
            alert('‚ùå Invalid backup file format');
            event.target.value = '';
            return;
          }
          
          const headers = rows[0].map(h => h.toLowerCase().trim());
          
          // Validate backup file headers
          const requiredHeaders = ['policy no', 'customer name', 'phone number', 'plan name', 'renewal date', 
                                   'sum insured', 'total premium', 'addon cost', 'age/dob', 
                                   'current status', 'latest notes', 'callback date/time', 'last updated', 
                                   'total calls', 'complete disposition log'];
          
          const hasAllHeaders = requiredHeaders.every(rh => 
            headers.some(h => h === rh)
          );
          
          if (!hasAllHeaders) {
            alert('‚ùå This is not a valid backup file.\n\nPlease upload a file exported from this system.');
            event.target.value = '';
            return;
          }
          
          const restoredData = [];
          const restoredDispositions = {};
          let successCount = 0;
          let errorCount = 0;
          
          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (row.length < 10) continue;
            
            try {
              const getCell = (colName) => {
                const idx = headers.indexOf(colName.toLowerCase());
                return idx >= 0 && idx < row.length ? row[idx] : '';
              };
              
              const policy = getCell('policy no');
              const name = getCell('customer name');
              const phone = getCell('phone number').replace(/[^0-9]/g, '');
              const planName = getCell('plan name');
              const renewalDate = getCell('renewal date');
              const sumInsured = getCell('sum insured');
              const premium = parseInt(getCell('total premium').replace(/[^0-9]/g, '')) || 0;
              const addonCost = parseInt(getCell('addon cost').replace(/[^0-9]/g, '')) || 0;
              const ageDob = getCell('age/dob');
              const currentStatus = getCell('current status').toLowerCase().replace(/ /g, '_');
              const notes = getCell('latest notes');
              const callbackStr = getCell('callback date/time');
              const lastUpdatedStr = getCell('last updated');
              const dispositionLog = getCell('complete disposition log');
              
              if (!policy || !name || !phone) {
                errorCount++;
                continue;
              }
              
              // Restore customer data
              const item = {
                sno: restoredData.length + 1,
                policy: policy,
                name: name,
                phone: phone,
                date: renewalDate,
                plan: `${planName} - SI: ${sumInsured}`,
                dob: ageDob,
                amount: premium,
                sumInsured: sumInsured,
                addonCost: addonCost
              };
              
              restoredData.push(item);
              
              // Restore disposition data
              const disposition = {
                status: currentStatus === 'pending' ? 'pending' : currentStatus,
                notes: notes && notes !== 'No notes added' ? notes : '',
                callback: null,
                lastUpdated: null,
                history: []
              };
              
              // Parse callback
              if (callbackStr && callbackStr !== 'Not Scheduled') {
                try {
                  const cbParts = callbackStr.split(' at ');
                  if (cbParts.length === 2) {
                    const cbDate = new Date(cbParts[0] + ' ' + cbParts[1]);
                    if (!isNaN(cbDate.getTime())) {
                      disposition.callback = cbDate.toISOString();
                    }
                  }
                } catch (e) {
                  console.warn('Could not parse callback date:', e);
                }
              }
              
              // Parse last updated
              if (lastUpdatedStr && lastUpdatedStr !== 'Never') {
                try {
                  const luParts = lastUpdatedStr.split(' at ');
                  if (luParts.length === 2) {
                    const luDate = new Date(luParts[0] + ' ' + luParts[1]);
                    if (!isNaN(luDate.getTime())) {
                      disposition.lastUpdated = luDate.toISOString();
                    }
                  }
                } catch (e) {
                  console.warn('Could not parse last updated:', e);
                }
              }
              
              // Parse disposition history
              if (dispositionLog && dispositionLog !== 'No interaction history available') {
                const logEntries = dispositionLog.split(' || ');
                
                logEntries.forEach(entry => {
                  try {
                    // Format: Call 1: [05 Oct 2025 at 02:30 PM] Status: INTERESTED | Notes: text | Callback Scheduled: ...
                    const dateTimeMatch = entry.match(/\[(.*?)\]/);
                    const statusMatch = entry.match(/Status:\s*([^|]+)/);
                    const notesMatch = entry.match(/Notes:\s*([^|]+)/);
                    const callbackMatch = entry.match(/Callback Scheduled:\s*(.+)$/);
                    
                    if (dateTimeMatch && statusMatch) {
                      // Parse timestamp
                      let timestamp;
                      try {
                        const dtStr = dateTimeMatch[1].trim();
                        // Convert "05 Oct 2025 at 02:30 PM" to Date
                        const parts = dtStr.split(' at ');
                        if (parts.length === 2) {
                          const dateStr = parts[0];
                          const timeStr = parts[1];
                          timestamp = new Date(dateStr + ' ' + timeStr);
                        } else {
                          timestamp = new Date(dtStr);
                        }
                      } catch (e) {
                        timestamp = new Date();
                      }
                      
                      // Parse status
                      const status = statusMatch[1].trim().toLowerCase().replace(/ /g, '_');
                      
                      // Parse notes
                      let histNotes = '';
                      if (notesMatch) {
                        histNotes = notesMatch[1].trim();
                        if (histNotes === 'No notes') {
                          histNotes = '';
                        }
                      }
                      
                      // Create history entry
                      const histEntry = {
                        status: status,
                        notes: histNotes,
                        timestamp: timestamp.toISOString(),
                        callback: null
                      };
                      
                      // Parse callback if exists
                      if (callbackMatch) {
                        try {
                          const cbStr = callbackMatch[1].trim();
                          const cbParts = cbStr.split(' at ');
                          if (cbParts.length === 2) {
                            const cbDate = new Date(cbParts[0] + ' ' + cbParts[1]);
                            if (!isNaN(cbDate.getTime())) {
                              histEntry.callback = cbDate.toISOString();
                            }
                          }
                        } catch (e) {
                          console.warn('Could not parse callback in history:', e);
                        }
                      }
                      
                      disposition.history.push(histEntry);
                    }
                  } catch (e) {
                    console.warn('Error parsing history entry:', entry, e);
                  }
                });
              }
              
              restoredDispositions[policy] = disposition;
              successCount++;
              
            } catch (err) {
              errorCount++;
              console.warn(`Error processing row ${i}:`, err);
            }
          }
          
          if (successCount === 0) {
            alert('‚ùå No valid data found in backup file');
            event.target.value = '';
            return;
          }
          
          // Apply restored data
          data.length = 0;
          data.push(...restoredData);
          
          dispositions = restoredDispositions;
          
          // Save to localStorage
          localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(data));
          localStorage.setItem(STORAGE_KEY, JSON.stringify(dispositions));
          
          // Refresh UI
          renderCards();
          updateCounts();
          
          alert(`‚úÖ Backup Restored Successfully!\n\nüìä Summary:\n‚Ä¢ Leads Restored: ${successCount}\n‚Ä¢ Total Interactions: ${Object.values(dispositions).reduce((sum, d) => sum + (d.history || []).length, 0)}\n${errorCount > 0 ? `\n‚ö†Ô∏è ${errorCount} rows had errors and were skipped.` : ''}\n\n‚ú® All customer data, dispositions, notes, callbacks, and complete history have been restored.`);
          
        } catch (error) {
          alert('‚ùå Error reading backup file: ' + error.message);
          console.error('Backup restore error:', error);
        }
      };
      
      reader.readAsText(file);
      event.target.value = '';
    }

    loadDispositions();
    renderCards();
    updateCounts();
  </script>
</body>
</html>